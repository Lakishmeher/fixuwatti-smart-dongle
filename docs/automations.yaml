# FixuWattiâ„¢ Home Assistant Automaatiot
# LisÃ¤Ã¤ nÃ¤mÃ¤ automations.yaml tiedostoon tai Home Assistant automaatio-editoriin

# Hinta-alarm: Ilmoitus kun sÃ¤hkÃ¶n hinta nousee korkeaksi
- alias: "FixuWattiâ„¢ Korkea sÃ¤hkÃ¶n hinta"
  description: "LÃ¤hetÃ¤ ilmoitus kun sÃ¤hkÃ¶n hinta ylittÃ¤Ã¤ 25 snt/kWh"
  trigger:
    - platform: numeric_state
      entity_id: sensor.nordpool_kwh_fi_eur_3_10_0_current_price
      above: 0.25  # â‚¬/kWh (25 snt)
  condition:
    - condition: time
      after: "06:00:00"
      before: "23:00:00"  # Ei hÃ¤lyytyksiÃ¤ yÃ¶llÃ¤
  action:
    - service: notify.mobile_app_iphone  # Vaihda omaan laitteeseen
      data:
        message: "âš¡ SÃ¤hkÃ¶n hinta korkea: {{ states('sensor.nordpool_kwh_fi_eur_3_10_0_current_price') }} â‚¬/kWh"
        title: "FixuWattiâ„¢ Hinta-alarm"
        data:
          push:
            badge: 1
            sound: "default"

# Halpa sÃ¤hkÃ¶: Ilmoitus kun hinta laskee alle tipping pointin
- alias: "FixuWattiâ„¢ Halpa sÃ¤hkÃ¶"
  description: "Ilmoita kun sÃ¤hkÃ¶ on halpaa (alle 9 snt/kWh)"
  trigger:
    - platform: numeric_state
      entity_id: sensor.nordpool_kwh_fi_eur_3_10_0_current_price
      below: 0.09  # â‚¬/kWh (9 snt)
  action:
    - service: notify.mobile_app_iphone
      data:
        message: "ðŸ’° SÃ¤hkÃ¶ halpaa! Hinta: {{ states('sensor.nordpool_kwh_fi_eur_3_10_0_current_price') }} â‚¬/kWh"
        title: "FixuWattiâ„¢ SÃ¤Ã¤stÃ¶mahdollisuus"
        data:
          push:
            badge: 1
            sound: "default"

# Akun matala SOC
- alias: "FixuWattiâ„¢ Matala akun varaus"
  description: "HÃ¤lytys kun akun SOC laskee alle 20%"
  trigger:
    - platform: numeric_state
      entity_id: sensor.fixuwatti_soc
      below: 20  # %
  condition:
    - condition: template
      value_template: "{{ trigger.to_state.state != 'unknown' }}"
  action:
    - service: notify.mobile_app_iphone
      data:
        message: "ðŸ”‹ FixuWattiâ„¢ akku matala: {{ states('sensor.fixuwatti_soc') }}%"
        title: "Akku-alarm"
        data:
          push:
            badge: 1
            sound: "critical"

# YhteyshÃ¤iriÃ¶: MQTT-yhteys katkennut
- alias: "FixuWattiâ„¢ YhteyshÃ¤iriÃ¶"
  description: "Ilmoitus jos FixuWattiâ„¢ ei lÃ¤hetÃ¤ dataa 10 minuuttiin"
  trigger:
    - platform: state
      entity_id: sensor.fixuwatti_soc
      to: "unavailable"
      for:
        minutes: 10
  action:
    - service: notify.mobile_app_iphone
      data:
        message: "âš ï¸ FixuWattiâ„¢ ei vastaa - tarkista MQTT-yhteys"
        title: "YhteyshÃ¤iriÃ¶"
        data:
          push:
            badge: 1
            sound: "default"

# Automaattinen releen ohjaus hinnan mukaan (vain jos manual-tila)
- alias: "FixuWattiâ„¢ Auto-ohjaus ON"
  description: "Kytke rele pÃ¤Ã¤lle kun hinta laskee alle 9 snt ja tila on AUTO"
  trigger:
    - platform: numeric_state
      entity_id: sensor.nordpool_kwh_fi_eur_3_10_0_current_price
      below: 0.09
  condition:
    - condition: state
      entity_id: sensor.fixuwatti_status
      state: "AUTO"
    - condition: state
      entity_id: switch.fixuwatti_rele
      state: "off"
  action:
    - service: switch.turn_on
      entity_id: switch.fixuwatti_rele
    - service: notify.mobile_app_iphone
      data:
        message: "âš¡ FixuWattiâ„¢ rele kytketty pÃ¤Ã¤lle - halpa sÃ¤hkÃ¶ ({{ states('sensor.nordpool_kwh_fi_eur_3_10_0_current_price') }} â‚¬/kWh)"
        title: "Automaattinen ohjaus"

- alias: "FixuWattiâ„¢ Auto-ohjaus OFF"
  description: "Kytke rele pois kun hinta nousee yli 25 snt ja tila on AUTO"
  trigger:
    - platform: numeric_state
      entity_id: sensor.nordpool_kwh_fi_eur_3_10_0_current_price
      above: 0.25
  condition:
    - condition: state
      entity_id: sensor.fixuwatti_status
      state: "AUTO"
    - condition: state
      entity_id: switch.fixuwatti_rele
      state: "on"
  action:
    - service: switch.turn_off
      entity_id: switch.fixuwatti_rele
    - service: notify.mobile_app_iphone
      data:
        message: "âš¡ FixuWattiâ„¢ rele kytketty pois - kallis sÃ¤hkÃ¶ ({{ states('sensor.nordpool_kwh_fi_eur_3_10_0_current_price') }} â‚¬/kWh)"
        title: "Automaattinen ohjaus"

# PÃ¤ivittÃ¤inen yhteenveto
- alias: "FixuWattiâ„¢ PÃ¤ivittÃ¤inen raportti"
  description: "LÃ¤hetÃ¤ pÃ¤ivÃ¤n energiatilastot aamulla klo 8"
  trigger:
    - platform: time
      at: "08:00:00"
  action:
    - service: notify.mobile_app_iphone
      data:
        message: >
          ðŸŒ… Huomenta! TÃ¤nÃ¤Ã¤n:
          ðŸ’° Keskihinta: {{ states('sensor.nordpool_kwh_fi_eur_3_10_0_current_price') }} â‚¬/kWh
          ðŸ”‹ Akku SOC: {{ states('sensor.fixuwatti_soc') }}%
          âš¡ Rele: {{ states('switch.fixuwatti_rele') }}
          ðŸ“Š Tila: {{ states('sensor.fixuwatti_status') }}
        title: "FixuWattiâ„¢ PÃ¤ivÃ¤n aloitus"
        data:
          push:
            badge: 0
